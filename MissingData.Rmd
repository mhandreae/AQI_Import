---
title: "Import AQI data"
author: "Michael Andreae"
date: "3 September 2015"
output: html_document
---

# Insurance status predicts antiemetic use 
We investigate the Hypothesis that socioeconomic status (**SES**) predicts anesthesia quality.

We use either insurance status or median income in patient address zip code as markers of socioeconomic status and  antiemetic use as marker of anesthesia quailty. We use the population in the Public Use File *NACOR*, the National Anesthesia Clinical Outcome Registry, of the Anesthesia Quality Institute *AQI* with electronic anesthesia records recording antiemetic use.


```{r, packages, message=FALSE, echo=FALSE, warning=FALSE}
require(knitr) # required to set options in Markdown R
```

```{r, global_options, echo=FALSE}
# set options
opts_chunk$set(fig.width=6, fig.height=4, fig.path='Figs/',
               echo=FALSE, warning=FALSE, message=FALSE)
# set working directory to source file location
#setwd("C:/Users/Micheal/Dropbox/Professional/AQI/AQI_Import")
```

# Import Data 

```{r, echo=TRUE}
# run only once
rm(list = ls())
setwd("C:/Users/Micheal/Dropbox/Professional/AQI/AQI_Import")
load("Data/PUF.Rdata")
```


### Missing data table

```{r}

# which position in the PUF datafram do the variable have
iAge <- 14
iPatientSex <-16
iASA <- 17
iAnes_type <- 28
iCPT <- 52
iProvider <- 62
iIncome_MedianR <- 76
iPayment <- 78

# make a list to call them in the loop
ilist<- c(iIncome_MedianR,
          iPayment,
          iProvider,
          iCPT,
          iASA,
          iAge,
          iAnes_type,
          iPatientSex)

# how many variables are there
n_i <- length (ilist)

# define dimensions for a table of missingness
mtable <- matrix(rep(0,n_i^2), ncol=n_i)

# for each variable fill the diagonal with the number of missing NAs
for (i in 1:n_i){
  mtable[n_i, n_i] <- sum( is.na(PUF[,ilist[i] ] ))
  
  # for each other variable
  for (j in i+1:n_i) {
    
    # make a the joint missingness table
    overlap<- table(is.na(PUF[,ilist[i] ]),is.na(PUF[,ilist[j] ]))

    # put the number of units with both variables observed in upper triangle                   
    mtable[i,j] <- overlap[1,1]
    
    # put the number of units with neither variables observed in lower triangle         
    mtable[j,i] <- overlap[2,2]
  }
}
  
sum( is.na(PUF[,ilist[1] ] ))

Overlap<- table(is.na(PUF$Payment),is.na(PUF$Income_MedianR))
head(PUF[1:10,76])
dimnames(PUF)

colnames(OverlapPayment_Income_MedianR) <- c("Observed Income", "NA")
rownames(OverlapPayment_Income_MedianR) <- c("Observed Insurance", "NA")

kable(OverlapPayment_Income_MedianR)
dim(OverlapPayment_Income_MedianR)
```